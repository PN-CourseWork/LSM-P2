# ============================================================================
#                         LSF EXPERIMENT CONFIGURATION
# ============================================================================
#
# Format:
#   GroupName:
#     lsf_options: [...]    # LSF bsub flags (can use {placeholders})
#     command: str          # Command template with placeholders
#     static_args: { ... }  # Fixed arguments (always applied)
#     sweep: { ... }        # Cartesian product sweep
#     sweep_paired: { ... } # Zipped sweep (values vary together)
#     env_vars: { ... }     # Environment variables (optional)
#
# Available placeholders:
#   {job_name}        - Auto-generated unique job name
#   {experiment_name} - Group name (default)
#   {LSF_OUTPUT_DIR}  - Session-specific output directory
#   {any_static_arg}  - Any key from static_args
#   {any_sweep_arg}   - Any key from sweep or sweep_paired
#
# Rank constraints (for cubic decomposition):
#   Perfect cubes: 1 (1³), 8 (2³), 27 (3³), 64 (4³)
#   Double cubes:  2 (2×1³), 16 (2×2³), 54 (2×3³)
#
# ============================================================================


# ############################################################################
#                            JACOBI ITERATION
# ############################################################################

# ============================================================================
# Strong Scaling (Jacobi)
# ============================================================================
# Fixed global problem size: 256³
# Sweeps: ranks × strategy × communicator
strong_scaling:
  lsf_options:
    - "-q hpc"
    - "-W 00:30"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=4GB]'"
    - "-R 'span[ptile=24]'"

  command: >-
    cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
    module purge && module load mpi && uv sync &&
    mpiexec --bind-to core --map-by core --report-bindings -n {ranks}
    uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy {strategy} --communicator {communicator}
    --tol {tol} --max-iter {max_iter} --numba
    --job-name {job_name} --experiment-name 05-scaling-{experiment_name}

  static_args:
    tol: 0.0
    max_iter: 100
    N: 256

  sweep:
    ranks: [1, 2, 8, 16, 27, 54, 64]
    strategy: ["sliced", "cubic"]
    communicator: ["numpy", "custom"]

# ============================================================================
# Weak Scaling (Jacobi)
# ============================================================================
# Local size per rank: ~64³ cells
# N scales with ranks to maintain constant work per rank
# Perfect cubes: P=n³ -> N=64n
# Double cubes:  P=2n³ -> N≈80n
weak_scaling:
  lsf_options:
    - "-q hpc"
    - "-W 00:30"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=4GB]'"
    - "-R 'span[ptile=24]'"

  command: >-
    cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
    module purge && module load mpi && uv sync &&
    mpiexec --bind-to core --map-by core --report-bindings -n {ranks}
    uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy {strategy} --communicator {communicator}
    --tol {tol} --max-iter {max_iter} --numba
    --job-name {job_name} --experiment-name 05-scaling-{experiment_name}

  static_args:
    tol: 0.0
    max_iter: 100

  sweep_paired:
    N: [64, 80, 128, 160, 192, 240, 256]
    ranks: [1, 2, 8, 16, 27, 54, 64]

  sweep:
    strategy: ["sliced", "cubic"]
    communicator: ["numpy", "custom"]


# ############################################################################
#                          FULL MULTIGRID (FMG)
# ############################################################################

# ============================================================================
# FMG Strong Scaling
# ============================================================================
# Fixed global problem size: 256³
# Cubic decomposition with custom communicator only
FMG_strong:
  lsf_options:
    - "-q hpc"
    - "-W 00:30"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=4GB]'"
    - "-R 'span[ptile=24]'"

  command: >-
    cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
    module purge && module load mpi && uv sync &&
    mpiexec --bind-to core --map-by core --report-bindings -n {ranks}
    uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy cubic --communicator custom
    --fmg --fmg-cycles {fmg_cycles} --numba
    --job-name {job_name} --experiment-name 05-scaling-{experiment_name}

  static_args:
    N: 256
    fmg_cycles: 1

  sweep:
    ranks: [1, 2, 8, 16, 27, 54, 64]

# ============================================================================
# FMG Weak Scaling
# ============================================================================
# Local size per rank: ~64³ cells
# Cubic decomposition with custom communicator only
FMG_weak:
  lsf_options:
    - "-q hpc"
    - "-W 00:30"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=4GB]'"
    - "-R 'span[ptile=24]'"

  command: >-
    cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
    module purge && module load mpi && uv sync &&
    mpiexec --bind-to core --map-by core --report-bindings -n {ranks}
    uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy cubic --communicator custom
    --fmg --fmg-cycles {fmg_cycles} --numba
    --job-name {job_name} --experiment-name 05-scaling-{experiment_name}

  static_args:
    fmg_cycles: 1

  sweep_paired:
    N: [64, 80, 128, 160, 192, 240, 256]
    ranks: [1, 2, 8, 16, 27, 54, 64]


# ############################################################################
#                      NO BINDING BASELINE (COMPARISON)
# ############################################################################
# Same experiments but WITHOUT --bind-to and --map-by options
# Used to demonstrate performance impact of proper process binding

# ============================================================================
# No Binding - Strong Scaling
# ============================================================================
no_binding_strong:
  lsf_options:
    - "-q hpc"
    - "-W 00:30"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=4GB]'"
    - "-R 'span[ptile=24]'"

  command: >-
    cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
    module purge && module load mpi && uv sync &&
    mpiexec -n {ranks}
    uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy {strategy} --communicator {communicator}
    --tol {tol} --max-iter {max_iter} --numba
    --job-name {job_name} --experiment-name 05-scaling-{experiment_name}

  static_args:
    tol: 0.0
    max_iter: 100
    N: 256

  sweep:
    ranks: [27, 64]
    strategy: ["cubic"]
    communicator: ["custom"]

# ============================================================================
# No Binding - Weak Scaling
# ============================================================================
no_binding_weak:
  lsf_options:
    - "-q hpc"
    - "-W 00:30"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=4GB]'"
    - "-R 'span[ptile=24]'"

  command: >-
    cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
    module purge && module load mpi && uv sync &&
    mpiexec -n {ranks}
    uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy {strategy} --communicator {communicator}
    --tol {tol} --max-iter {max_iter} --numba
    --job-name {job_name} --experiment-name 05-scaling-{experiment_name}

  static_args:
    tol: 0.0
    max_iter: 100

  sweep_paired:
    N: [192, 256]
    ranks: [27, 64]

  sweep:
    strategy: ["cubic"]
    communicator: ["custom"]
