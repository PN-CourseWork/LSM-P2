# ============================================================================
# LSF Experiment Configuration
# ============================================================================
# Format:
# GroupName:
#   lsf_options: [...]    # List of LSF bsub flags, can use placeholders {var}
#   command: str          # Full command template with placeholders for sweep/static args
#   static_args: { ... }  # Static arguments (always applied, can be used in command template)
#   sweep: { ... }        # Arguments to sweep over (cartesian product)
#   env_vars: { ... }     # Environment variables to set for the job (optional)

# Placeholders available for formatting:
#   - Any key from static_args or sweep
#   - job_name (generated uniquely per job)
#   - LSF_OUTPUT_DIR (absolute path to session-specific output directory for job logs)
#   - experiment_name (set to group name by default)

# ----------------------------------------------------------------------------
# Group 1: Single Node Strong Scaling
# ----------------------------------------------------------------------------
SN_strong:
  lsf_options:
    - "-q hpc"
    - "-W 00:10"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=4GB]'"
    - "-R 'span[hosts=1]'"
    - "-g /poisson_project/strong_scaling"

  command: >-
    module purge && uv sync &&
    mpiexec -n {ranks} uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy {strategy} --communicator {communicator}
    --tol {tol} --max-iter {max_iter} --numba
    --job-name {job_name} --experiment-name {experiment_name}

  static_args:
    tol: 0.0
    max_iter: 200

  sweep:
    N: [32]
    ranks: [8]
    strategy: ["sliced", "cubic"]
    communicator: ["numpy", "custom"]

# ----------------------------------------------------------------------------
# Group 2: Multi Node Strong Scaling
# ----------------------------------------------------------------------------
MN_strong:
  lsf_options:
    - "-q hpc"
    - "-W 00:20"
    - "-x"
    - "-n {ranks}"
    - "-J {job_name}"
    - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
    - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
    - "-R 'rusage[mem=8GB]'"
    - "-R 'span[ptile=24]'"
    - "-g /poisson_project/strong_scaling"

  command: >-
    module load python3/3.12.9 && module load mpi4py/4.0.1-python-3.12.9 && uv sync &&
    mpiexec -n {ranks} --map-by ppr:24:node --bind-to core
    uv run python Experiments/05-scaling/runner.py
    --N {N} --strategy {strategy} --communicator {communicator}
    --tol {tol} --max-iter {max_iter} --numba
    --job-name {job_name} --experiment-name {experiment_name}

  static_args:
    tol: 1e-6
    max_iter: 10000

  sweep:
    N: [256]
    ranks: [24, 48, 96]
    strategy: ["sliced", "cubic"]
    communicator: ["numpy", "custom"]
