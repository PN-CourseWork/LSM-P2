# ============================================================================
#                         LSF EXPERIMENT CONFIGURATION
# ============================================================================
#
# Structure:
#   pack_name:           # Generates pack_name.pack
#     group_name:        # Group within the pack
#       lsf_options: []
#       command: str
#       static_args: {}
#       sweep: {}
#       sweep_paired: {}
#
# Generate all packs: python main.py --hpc
#
# ============================================================================


# ############################################################################
#                                   TEST
# ############################################################################

test:
  sanity:
    lsf_options:
      - "-q hpc"
      - "-W 00:10"
      - "-n {n_cores}"
      - "-J {job_name}"
      - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
      - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
      - "-R 'rusage[mem=2GB]'"
      - "-R 'span[ptile=24]'"

    command: >-
      cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
      module purge && module load mpi && uv sync &&
      export NUMBA_NUM_THREADS=1 &&
      mpiexec {map_by} --bind-to core -n {ranks}
      uv run python Experiments/06-scaling/jacobi_runner.py
      --N {N} --strategy cubic --communicator custom
      --tol 0.0 --max-iter 10 --numba
      --job-name {job_name} --experiment-name 06-scaling-{experiment_name}

    static_args:
      N: 64

    sweep_paired:
      ranks: [1, 12, 24]
      n_cores: [24, 24, 24]
      map_by: ["--map-by core", "--map-by ppr:12:package", "--map-by ppr:12:package"]


# ############################################################################
#                          JACOBI STRONG SCALING
# ############################################################################

jacobi_strong_scaling:

  # --------------------------------------------------------------------------
  # Multi-socket strong scaling (spread across sockets for memory bandwidth)
  # Fixed problem size: 288³
  # --------------------------------------------------------------------------
  strong_scaling:
    lsf_options:
      - "-q hpc"
      - "-W 00:30"
      - "-n {n_cores}"
      - "-J {job_name}"
      - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
      - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
      - "-R 'rusage[mem=4GB]'"
      - "-R 'span[ptile=24]'"

    command: >-
      cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
      module purge && module load mpi && uv sync &&
      export NUMBA_NUM_THREADS=1 &&
      mpiexec {map_by} --bind-to core --report-bindings -n {ranks}
      uv run python Experiments/06-scaling/jacobi_runner.py
      --N {N} --strategy {strategy} --communicator {communicator}
      --tol {tol} --max-iter {max_iter} --numba
      --job-name {job_name} --experiment-name 06-scaling-{experiment_name}

    static_args:
      tol: 0.0
      max_iter: 100
      N: 288

    sweep_paired:
      ranks: [1, 8, 12, 24, 48, 96]
      n_cores: [24, 24, 24, 24, 48, 96]
      map_by: ["--map-by core", "--map-by core", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package"]

    sweep:
      strategy: ["sliced", "cubic"]
      communicator: ["numpy", "custom"]

  # --------------------------------------------------------------------------
  # Single socket baseline (all ranks share 76.8 GB/s bandwidth)
  # --------------------------------------------------------------------------
  single_socket_strong:
    lsf_options:
      - "-q hpc"
      - "-W 00:30"
      - "-n 12"
      - "-J {job_name}"
      - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
      - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
      - "-R 'rusage[mem=4GB]'"
      - "-R 'span[hosts=1] affinity[core(1,same=socket)]'"

    command: >-
      cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
      module purge && module load mpi && uv sync &&
      export NUMBA_NUM_THREADS=1 &&
      mpiexec --bind-to core --report-bindings -n {ranks}
      uv run python Experiments/06-scaling/jacobi_runner.py
      --N {N} --strategy {strategy} --communicator {communicator}
      --tol {tol} --max-iter {max_iter} --numba
      --job-name {job_name} --experiment-name 06-scaling-{experiment_name}

    static_args:
      tol: 0.0
      max_iter: 100
      N: 288

    sweep:
      ranks: [1, 4, 8, 12]
      strategy: ["cubic"]
      communicator: ["custom"]


# ############################################################################
#                          JACOBI WEAK SCALING
# ############################################################################

jacobi_weak_scaling:

  # --------------------------------------------------------------------------
  # Multi-socket weak scaling (N scales with ranks)
  # N = 64 × cbrt(P)
  # --------------------------------------------------------------------------
  weak_scaling:
    lsf_options:
      - "-q hpc"
      - "-W 00:30"
      - "-n {n_cores}"
      - "-J {job_name}"
      - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
      - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
      - "-R 'rusage[mem=4GB]'"
      - "-R 'span[ptile=24]'"

    command: >-
      cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
      module purge && module load mpi && uv sync &&
      export NUMBA_NUM_THREADS=1 &&
      mpiexec {map_by} --bind-to core --report-bindings -n {ranks}
      uv run python Experiments/06-scaling/jacobi_runner.py
      --N {N} --strategy {strategy} --communicator {communicator}
      --tol {tol} --max-iter {max_iter} --numba
      --job-name {job_name} --experiment-name 06-scaling-{experiment_name}

    static_args:
      tol: 0.0
      max_iter: 100

    sweep_paired:
      ranks: [1, 8, 12, 24, 48, 96]
      n_cores: [24, 24, 24, 24, 48, 96]
      N: [64, 128, 147, 184, 232, 292]
      map_by: ["--map-by core", "--map-by core", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package"]

    sweep:
      strategy: ["sliced", "cubic"]
      communicator: ["numpy", "custom"]

  # --------------------------------------------------------------------------
  # Single socket baseline
  # --------------------------------------------------------------------------
  single_socket_weak:
    lsf_options:
      - "-q hpc"
      - "-W 00:30"
      - "-n 12"
      - "-J {job_name}"
      - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
      - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
      - "-R 'rusage[mem=4GB]'"
      - "-R 'span[hosts=1] affinity[core(1,same=socket)]'"

    command: >-
      cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
      module purge && module load mpi && uv sync &&
      export NUMBA_NUM_THREADS=1 &&
      mpiexec --bind-to core --report-bindings -n {ranks}
      uv run python Experiments/06-scaling/jacobi_runner.py
      --N {N} --strategy {strategy} --communicator {communicator}
      --tol {tol} --max-iter {max_iter} --numba
      --job-name {job_name} --experiment-name 06-scaling-{experiment_name}

    static_args:
      tol: 0.0
      max_iter: 100

    sweep_paired:
      ranks: [1, 4, 8, 12]
      N: [64, 102, 128, 147]

    sweep:
      strategy: ["cubic"]
      communicator: ["custom"]


# ############################################################################
#                          FMG STRONG SCALING
# ############################################################################

FMG_strong_scaling:

  FMG_strong:
    lsf_options:
      - "-q hpc"
      - "-W 00:30"
      - "-n {n_cores}"
      - "-J {job_name}"
      - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
      - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
      - "-R 'rusage[mem=4GB]'"
      - "-R 'span[ptile=24]'"

    command: >-
      cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
      module purge && module load mpi && uv sync &&
      mpiexec {map_by} --bind-to core --report-bindings -n {ranks}
      uv run python Experiments/06-scaling/fmg_runner.py
      --N {N} --strategy cubic --communicator custom
      --cycles {cycles} --n-smooth {n_smooth}
      --job-name {job_name} --experiment-name 06-scaling-{experiment_name}

    static_args:
      N: 289
      cycles: 1
      n_smooth: 3

    sweep_paired:
      ranks: [1, 8, 12, 24, 48, 96]
      n_cores: [24, 24, 24, 24, 48, 96]
      map_by: ["--map-by core", "--map-by core", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package"]


# ############################################################################
#                          FMG WEAK SCALING
# ############################################################################

FMG_weak_scaling:

  FMG_weak:
    lsf_options:
      - "-q hpc"
      - "-W 00:30"
      - "-n {n_cores}"
      - "-J {job_name}"
      - "-o {LSF_OUTPUT_DIR}/{job_name}.out"
      - "-e {LSF_OUTPUT_DIR}/{job_name}.err"
      - "-R 'rusage[mem=4GB]'"
      - "-R 'span[ptile=24]'"

    command: >-
      cd $LSB_SUBCWD && mkdir -p {LSF_OUTPUT_DIR} &&
      module purge && module load mpi && uv sync &&
      mpiexec {map_by} --bind-to core --report-bindings -n {ranks}
      uv run python Experiments/06-scaling/fmg_runner.py
      --N {N} --strategy cubic --communicator custom
      --cycles {cycles} --n-smooth {n_smooth}
      --job-name {job_name} --experiment-name 06-scaling-{experiment_name}

    static_args:
      cycles: 1
      n_smooth: 3

    sweep_paired:
      ranks: [1, 8, 12, 24, 48, 96]
      n_cores: [24, 24, 24, 24, 48, 96]
      N: [65, 129, 148, 185, 233, 293]
      map_by: ["--map-by core", "--map-by core", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package", "--map-by ppr:12:package"]
